(in-package trie.test)

(defvar *entity-reference* 
    '((#\Ã† "&AElig" "&#198;" "&#x00C6;")
      (#\Ã† "&AElig;"  "&#x00C6;")
      (#\& "&AMP" "&#38;" "&#x0026;")
      (#\& "&AMP;" "&#38;" "&#x0026;")
      (#\Ã "&Aacute" "&#193;" "&#x00C1;")
      (#\Ã "&Aacute;" "&#193;" "&#x00C1;")
      (#\Ä‚ "&Abreve;" "&#258;" "&#x0102;")
      (#\Ã‚ "&Acirc" "&#194;" "&#x00C2;")
      (#\Ã‚ "&Acirc;" "&#194;" "&#x00C2;")
      (#\Ğ "&Acy;" "&#1040;" "&#x0410;")
      (#\ğ”„ "&Afr;" "&#120068;" "&#xD835;" "&#xDD04;")
      (#\Ã€ "&Agrave" "&#192;" "&#x00C0;")
      (#\Ã€ "&Agrave;" "&#192;" "&#x00C0;")
      (#\Î‘ "&Alpha;" "&#913;" "&#x0391;")
      (#\Ä€ "&Amacr;" "&#256;" "&#x0100;")
      (#\â©“ "&And;" "&#10835;" "&#x2A53;")
      (#\Ä„ "&Aogon;" "&#260;" "&#x0104;")
      (#\ğ”¸ "&Aopf;" "&#120120;" "&#xDD38;")
      (#\â¡ "&ApplyFunction;" "&#8289;" "&#x2061;")
      (#\Ã… "&Aring" "&#197;" "&#x00C5;")
      (#\Ã… "&Aring;" "&#197;" "&#x00C5;")
      (#\ğ’œ "&Ascr;" "&#119964;" "&#xDC9C;")
      (#\â‰” "&Assign;" "&#8788;" "&#x2254;")
      (#\Ãƒ "&Atilde" "&#195;" "&#x00C3;")
      (#\Ãƒ "&Atilde;" "&#195;" "&#x00C3;")
      (#\Ã„ "&Auml" "&#196;" "&#x00C4;")
      (#\Ã„ "&Auml;" "&#196;" "&#x00C4;")
      (#\âˆ– "&Backslash;" "&#8726;" "&#x2216;")
      (#\â«§ "&Barv;" "&#10983;" "&#x2AE7;")
      (#\âŒ† "&Barwed;" "&#8966;" "&#x2306;")
      (#\Ğ‘ "&Bcy;" "&#1041;" "&#x0411;")
      (#\âˆµ "&Because;" "&#8757;" "&#x2235;")
      (#\â„¬ "&Bernoullis;" "&#8492;" "&#x212C;")
      (#\Î’ "&Beta;" "&#914;" "&#x0392;")
      (#\ğ”… "&Bfr;" "&#120069;" "&#xDD05;")
      (#\ğ”¹ "&Bopf;" "&#120121;" "&#xDD39;")
      (#\Ë˜ "&Breve;" "&#728;" "&#x02D8;")
      (#\â„¬ "&Bscr;" "&#8492;" "&#x212C;")
      (#\â‰ "&Bumpeq;" "&#8782;" "&#x224E;")
      (#\Ğ§ "&CHcy;" "&#1063;" "&#x0427;")
      (#\Â© "&COPY" "&#169;" "&#x00A9;")
      (#\Â© "&COPY;" "&#169;" "&#x00A9;")
      (#\Ä† "&Cacute;" "&#262;" "&#x0106;")
      (#\â‹’ "&Cap;" "&#8914;" "&#x22D2;")
      (#\â…… "&CapitalDifferentialD;" "&#8517;" "&#x2145;")
      (#\â„­ "&Cayleys;" "&#8493;" "&#x212D;")
      (#\ÄŒ "&Ccaron;" "&#268;" "&#x010C;")
      (#\Ã‡ "&Ccedil" "&#199;" "&#x00C7;")
      (#\Ã‡ "&Ccedil;" "&#199;" "&#x00C7;")
      (#\Äˆ "&Ccirc;" "&#264;" "&#x0108;")
      (#\âˆ° "&Cconint;" "&#8752;" "&#x2230;")
      (#\ÄŠ "&Cdot;" "&#266;" "&#x010A;")
      (#\Â¸ "&Cedilla;" "&#184;" "&#x00B8;")
      (#\Â· "&CenterDot;" "&#183;" "&#x00B7;")
      (#\â„­ "&Cfr;" "&#8493;" "&#x212D;")
      (#\Î§ "&Chi;" "&#935;" "&#x03A7;")
      (#\âŠ™ "&CircleDot;" "&#8857;" "&#x2299;")
      (#\âŠ– "&CircleMinus;" "&#8854;" "&#x2296;")
      (#\âŠ• "&CirclePlus;" "&#8853;" "&#x2295;")
      (#\âŠ— "&CircleTimes;" "&#8855;" "&#x2297;")
      (#\âˆ² "&ClockwiseContourIntegral;" "&#8754;" "&#x2232;")
      (#\â€ "&CloseCurlyDoubleQuote;" "&#8221;" "&#x201D;")
      (#\â€™ "&CloseCurlyQuote;" "&#8217;" "&#x2019;")
      (#\âˆ· "&Colon;" "&#8759;" "&#x2237;")
      (#\â©´ "&Colone;" "&#10868;" "&#x2A74;")
      (#\â‰¡ "&Congruent;" "&#8801;" "&#x2261;")
      (#\âˆ¯ "&Conint;" "&#8751;" "&#x222F;")
      (#\âˆ® "&ContourIntegral;" "&#8750;" "&#x222E;")
      (#\â„‚ "&Copf;" "&#8450;" "&#x2102;")
      (#\âˆ "&Coproduct;" "&#8720;" "&#x2210;")
      (#\âˆ³ "&CounterClockwiseContourIntegral;" "&#8755;" "&#x2233;")
      (#\â¨¯ "&Cross;" "&#10799;" "&#x2A2F;")
      (#\ğ’ "&sdCscr;" "&#119966;" "&#xDC9E;")
      (#\â‹“ "&Cup;" "&#8915;" "&#x22D3;")
      (#\â‰ "&CupCap;" "&#8781;" "&#x224D;")
      (#\â…… "&DD;" "&#8517;" "&#x2145;")
      (#\â¤‘ "&DDotrahd;" "&#10513;" "&#x2911;")
      (#\Ğ‚ "&DJcy;" "&#1026;" "&#x0402;")
      (#\Ğ… "&DScy;" "&#1029;" "&#x0405;")
      (#\Ğ "&DZcy;" "&#1039;" "&#x040F;")
      (#\â€¡ "&Dagger;" "&#8225;" "&#x2021;")
      (#\â†¡ "&Darr;" "&#8609;" "&#x21A1;")
      (#\â«¤ "&Dashv;" "&#10980;" "&#x2AE4;")
      (#\Ä "&Dcaron;" "&#270;" "&#x010E;")
      (#\Ğ” "&Dcy;" "&#1044;" "&#x0414;")
      (#\âˆ‡ "&Del;" "&#8711;" "&#x2207;")
      (#\Î” "&Delta;" "&#916;" "&#x0394;")
      (#\ğ”‡ "&Dfr;" "&#120071;" "&#xDD07;")
      (#\Â´ "&DiacriticalAcute;" "&#180;" "&#x00B4;")
      (#\Ë™ "&DiacriticalDot;" "&#729;" "&#x02D9;")
      (#\Ë "&DiacriticalDoubleAcute;" "&#733;" "&#x02DD;")
      (#\` "&DiacriticalGrave;" "&#96;" "&#x0060;")
      (#\Ëœ "&DiacriticalTilde;" "&#732;" "&#x02DC;")
      (#\â‹„ "&Diamond;" "&#8900;" "&#x22C4;")
      (#\â…† "&DifferentialD;" "&#8518;" "&#x2146;")
      (#\ğ”» "&Dopf;" "&#120123;" "&#xDD3B;")
      (#\Â¨ "&Dot;" "&#168;" "&#x00A8;")
      (#\âƒœ "&DotDot;" "&#8412;" "&#x20DC;")
      (#\â‰ "&DotEqual;" "&#8784;" "&#x2250;")
      (#\âˆ¯ "&DoubleContourIntegral;" "&#8751;" "&#x222F;")
      (#\Â¨ "&DoubleDot;" "&#168;" "&#x00A8;")
      (#\â‡“ "&DoubleDownArrow;" "&#8659;" "&#x21D3;")
      (#\â‡ "&DoubleLeftArrow;" "&#8656;" "&#x21D0;")
      (#\â‡” "&DoubleLeftRightArrow;" "&#8660;" "&#x21D4;")
      (#\â«¤ "&DoubleLeftTee;" "&#10980;" "&#x2AE4;")
      (#\âŸ¸ "&DoubleLongLeftArrow;" "&#10232;" "&#x27F8;")
      (#\âŸº "&DoubleLongLeftRightArrow;" "&#10234;" "&#x27FA;")
      (#\âŸ¹ "&DoubleLongRightArrow;" "&#10233;" "&#x27F9;")
      (#\â‡’ "&DoubleRightArrow;" "&#8658;" "&#x21D2;")
      (#\âŠ¨ "&DoubleRightTee;" "&#8872;" "&#x22A8;")
      (#\â‡‘ "&DoubleUpArrow;" "&#8657;" "&#x21D1;")
      (#\â‡• "&DoubleUpDownArrow;" "&#8661;" "&#x21D5;")
      (#\âˆ¥ "&DoubleVerticalBar;" "&#8741;" "&#x2225;")
      (#\â†“ "&DownArrow;" "&#8595;" "&#x2193;")
      (#\â¤“ "&DownArrowBar;" "&#10515;" "&#x2913;")
      (#\â‡µ "&DownArrowUpArrow;" "&#8693;" "&#x21F5;")
      (#\Ì‘ "&DownBreve;" "&#785;" "&#x0311;")
      (#\â¥ "&DownLeftRightVector;" "&#10576;" "&#x2950;")
      (#\â¥ "&DownLeftTeeVector;" "&#10590;" "&#x295E;")
      (#\â†½ "&DownLeftVector;" "&#8637;" "&#x21BD;")
      (#\â¥– "&DownLeftVectorBar;" "&#10582;" "&#x2956;")
      (#\â¥Ÿ "&DownRightTeeVector;" "&#10591;" "&#x295F;")
      (#\â‡ "&DownRightVector;" "&#8641;" "&#x21C1;")
      (#\â¥— "&DownRightVectorBar;" "&#10583;" "&#x2957;")
      (#\âŠ¤ "&DownTee;" "&#8868;" "&#x22A4;")
      (#\â†§ "&DownTeeArrow;" "&#8615;" "&#x21A7;")
      (#\â‡“ "&Downarrow;" "&#8659;" "&#x21D3;")
      (#\ğ’Ÿ "&Dscr;" "&#119967;"  "&#xDC9F;")
      (#\Ä "&Dstrok;" "&#272;" "&#x0110;")
      (#\ÅŠ "&ENG;" "&#330;" "&#x014A;")
      (#\Ã "&ETH" "&#208;" "&#x00D0;")
      (#\Ã "&ETH;" "&#208;" "&#x00D0;")
      (#\Ã‰ "&Eacute" "&#201;" "&#x00C9;")
      (#\Ã‰ "&Eacute;" "&#201;" "&#x00C9;")
      (#\Äš "&Ecaron;" "&#282;" "&#x011A;")
      (#\ÃŠ "&Ecirc" "&#202;" "&#x00CA;")
      (#\ÃŠ "&Ecirc;" "&#202;" "&#x00CA;")
      (#\Ğ­ "&Ecy;" "&#1069;" "&#x042D;")
      (#\Ä– "&Edot;" "&#278;" "&#x0116;")
      (#\ğ”ˆ "&Efr;" "&#120072;"  "&#xDD08;")
      (#\Ãˆ "&Egrave" "&#200;" "&#x00C8;")
      (#\Ãˆ "&Egrave;" "&#200;" "&#x00C8;")
      (#\âˆˆ "&Element;" "&#8712;" "&#x2208;")
      (#\Ä’ "&Emacr;" "&#274;" "&#x0112;")
      (#\â—» "&EmptySmallSquare;" "&#9723;" "&#x25FB;")
      (#\â–« "&EmptyVerySmallSquare;" "&#9643;" "&#x25AB;")
      (#\Ä˜ "&Eogon;" "&#280;" "&#x0118;")
      (#\ğ”¼ "&Eopf;" "&#120124;"  "&#xDD3C;")
      (#\Î• "&Epsilon;" "&#917;" "&#x0395;")
      (#\â©µ "&Equal;" "&#10869;" "&#x2A75;")
      (#\â‰‚ "&EqualTilde;" "&#8770;" "&#x2242;")
      (#\â‡Œ "&Equilibrium;" "&#8652;" "&#x21CC;")
      (#\â„° "&Escr;" "&#8496;" "&#x2130;")
      (#\â©³ "&Esim;" "&#10867;" "&#x2A73;")
      (#\Î— "&Eta;" "&#919;" "&#x0397;")
      (#\Ã‹ "&Euml" "&#203;" "&#x00CB;")
      (#\Ã‹ "&Euml;" "&#203;" "&#x00CB;")
      (#\âˆƒ "&Exists;" "&#8707;" "&#x2203;")
      (#\â…‡ "&ExponentialE;" "&#8519;" "&#x2147;")
      (#\Ğ¤ "&Fcy;" "&#1060;" "&#x0424;")
      (#\ğ”‰ "&Ffr;" "&#120073;"  "&#xDD09;")
      (#\â—¼ "&FilledSmallSquare;" "&#9724;" "&#x25FC;")
      (#\â–ª "&FilledVerySmallSquare;" "&#9642;" "&#x25AA;")
      (#\ğ”½ "&Fopf;" "&#120125;"  "&#xDD3D;")
      (#\âˆ€ "&ForAll;" "&#8704;" "&#x2200;")
      (#\â„± "&Fouriertrf;" "&#8497;" "&#x2131;")
      (#\â„± "&Fscr;" "&#8497;" "&#x2131;")
      (#\Ğƒ "&GJcy;" "&#1027;" "&#x0403;")
      (#\> "&GT" "&#62;" "&#x003E;")
      (#\> "&GT;" "&#62;" "&#x003E;")
      (#\Î“ "&Gamma;" "&#915;" "&#x0393;")
      (#\Ïœ "&Gammad;" "&#988;" "&#x03DC;")
      (#\Ä "&Gbreve;" "&#286;" "&#x011E;")
      (#\Ä¢ "&Gcedil;" "&#290;" "&#x0122;")
      (#\Äœ "&Gcirc;" "&#284;" "&#x011C;")
      (#\Ğ“ "&Gcy;" "&#1043;" "&#x0413;")
      (#\Ä  "&Gdot;" "&#288;" "&#x0120;")
      (#\ğ”Š "&Gfr;" "&#120074;"  "&#xDD0A;")
      (#\â‹™ "&Gg;" "&#8921;" "&#x22D9;")))


(defun entity-trie (entities-list &optional (trie (make-trie)) (fn #'identity))
  (loop for entity-list in entities-list
     for character = (car entity-list)
     for entities = (cdr entity-list)
     do (loop for entity in entities
	   do (insert-word (funcall fn entity) trie character)))
  trie)

(define-test trie...
  :parent stw-tries...
  (let ((trie (entity-trie *entity-reference*)))
    (loop
      for entity-list in *entity-reference*
      for character = (car entity-list)
      for entities = (cdr entity-list)
      do (loop
	   for entity in entities
	   do (is char= character (find-word entity trie))))))

(define-test rtrie...
  :parent stw-tries...
  (let ((rtrie (entity-trie *entity-reference* (make-radix-trie))))
    (loop
      for entity-list in *entity-reference*
      for character = (car entity-list)
      for entities = (cdr entity-list)
      do (loop
	   for entity in entities
	   do (is char= character (find-word entity rtrie))))))

(define-test btrie...
  :parent stw-tries...
  (let ((btrie (entity-trie *entity-reference* (make-byte-trie) #'util.binary:string-to-octets)))
    (loop
      for entity-list in *entity-reference*
      for character = (car entity-list)
      for entities = (cdr entity-list)
      do (loop
	   for entity in entities
	   do (is char= character (find-word (util.binary:string-to-octets entity) btrie))))))
